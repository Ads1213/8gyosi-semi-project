<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.kh.eightgyosi.board.model.mapper.EditBoardMapper">

    <!-- 게시글 작성 -->
    
	<insert id="insertBoard" useGeneratedKeys="true" keyProperty="boardId">
	
	    <selectKey keyProperty="boardId" resultType="_int" order="BEFORE">
	        SELECT SEQ_BOARD_NO.NEXTVAL FROM DUAL
	    </selectKey>
	
	    INSERT INTO board (board_id, board_title, board_content, board_view_count, 
	                       board_is_deleted, board_create, board_updated, 
	                       board_type_no, member_no)
	    VALUES (#{boardId}, #{boardTitle}, #{boardContent}, 0, 'N', SYSDATE, SYSDATE, #{boardTypeNo}, #{memberNo})
	</insert>

    <!-- 게시글 수정 -->
    <update id="updateBoard">
        UPDATE board
        SET title = #{title},
            content = #{content},
            update_date = NOW()
        WHERE board_id = #{boardId}
    </update>

    <!-- 게시글 삭제 -->
    <delete id="deleteBoard">
        DELETE FROM board
        WHERE board_id = #{boardId} AND member_no = #{memberNo}
    </delete>

    <!-- 단일 게시글 조회 -->
    <select id="selectBoardDetail" resultType="edu.kh.eightgyosi.board.model.dto.Board">
        SELECT board_id, board_type_no, member_no, title, content, create_date, update_date
        FROM board
        WHERE board_id = #{boardId}
    </select>

    <!-- 게시글 이미지 조회 -->
    <select id="selectBoardImages" resultType="edu.kh.eightgyosi.board.model.dto.BoardImage">
        SELECT img_no, board_id, img_order, img_path, img_rename, img_original_name, img_size
        FROM board_image
        WHERE board_id = #{boardId}
        ORDER BY img_order ASC
    </select>

    <!-- 게시글 파일 조회 -->
    <select id="selectBoardFiles" resultType="edu.kh.eightgyosi.board.model.dto.BoardFile">
        SELECT uploadfile_no, board_id, uploadfile_origin, uploadfile_strg, uploadfile_size, uploadfile_date, uploadfile_path
        FROM board_file
        WHERE board_id = #{boardId}
    </select>

    <!-- 단일 이미지 조회 -->
    <select id="selectBoardImageById" resultType="edu.kh.eightgyosi.board.model.dto.BoardImage">
        SELECT * FROM board_image WHERE img_no = #{imgNo}
    </select>

    <!-- 단일 파일 조회 -->
    <select id="selectBoardFile" resultType="edu.kh.eightgyosi.board.model.dto.BoardFile">
        SELECT * FROM board_file WHERE uploadfile_no = #{fileNo}
    </select>

    <!-- 이미지 삽입 -->
    <insert id="insertBoardImage">
        INSERT INTO board_image (board_id, img_order, img_path, img_rename, img_original_name, img_size)
        VALUES (#{boardId}, #{imgOrder}, #{imgPath}, #{imgRename}, #{imgOriginalName}, #{imgSize})
    </insert>

    <!-- 이미지 삭제 -->
    <delete id="deleteBoardImage">
        DELETE FROM board_image WHERE img_no = #{imgNo}
    </delete>

    <!-- 파일 삽입 -->
    <insert id="insertBoardFile">
        INSERT INTO board_file (board_id, uploadfile_origin, uploadfile_strg, uploadfile_size, uploadfile_date, uploadfile_path)
        VALUES (#{boardId}, #{uploadfileOrigin}, #{uploadfileStrg}, #{uploadfileSize}, #{uploadfileDate}, #{uploadfilePath})
    </insert>

    <!-- 파일 삭제 -->
    <delete id="deleteBoardFile">
        DELETE FROM board_file WHERE uploadfile_no = #{fileNo}
    </delete>

    <!-- 이미지 최대 순서 조회 -->
    <select id="selectMaxImgOrder" resultType="int">
        SELECT IFNULL(MAX(img_order), 0)
        FROM board_image
        WHERE board_id = #{boardId}
    </select>

    <!-- 카테고리 조회 -->
    <select id="selectCategoryList" resultType="edu.kh.eightgyosi.board.model.dto.BoardType">
        SELECT board_type_no, board_type_name
        FROM board_type
        ORDER BY BOARD_TYPE_NO ASC
    </select>

</mapper>

